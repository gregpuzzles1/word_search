name: Generate Wordcache Category Labels

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

permissions:
  contents: write

jobs:
  generate-categories:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Send folder slugs to Lambda and write categories.json
        shell: bash
        env:
          CATEGORIES_FUNCTION_URL: ${{ secrets.CATEGORIES_FUNCTION_URL }}
        run: |
          set -euo pipefail

          BASE_DIR="public/wordcache"
          OUT_FILE="${BASE_DIR}/categories.json"

          if [ -z "${CATEGORIES_FUNCTION_URL:-}" ]; then
            echo "❌ Missing secret: CATEGORIES_FUNCTION_URL"
            exit 1
          fi

          if [ ! -d "$BASE_DIR" ]; then
            echo "❌ Missing folder: $BASE_DIR"
            exit 1
          fi

          # Collect top-level folders (slugs)
          mapfile -t SLUGS < <(find "$BASE_DIR" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort)

          if [ "${#SLUGS[@]}" -eq 0 ]; then
            echo "❌ No category folders found under $BASE_DIR"
            exit 1
          fi

          echo "✅ Found ${#SLUGS[@]} category folders:"
          printf ' - %s\n' "${SLUGS[@]}"

          # Build SLUGS_TEXT as newline-separated list
          SLUGS_TEXT="$(printf "%s\n" "${SLUGS[@]}")"

          # Build JSON payload via python (no heredoc; avoids editor lint issues)
          REQUEST_JSON="$(SLUGS_TEXT="$SLUGS_TEXT" python3 -c 'import json,os; slugs=[s.strip() for s in os.environ.get("SLUGS_TEXT","").splitlines() if s.strip()]; print(json.dumps({"slugs": slugs, "base_path": "public/wordcache"}))')"

          # Sanitize URL (strip CRLF and surrounding whitespace)
          CATEGORIES_FUNCTION_URL="${CATEGORIES_FUNCTION_URL//$'\r'/}"
          CATEGORIES_FUNCTION_URL="$(printf "%s" "$CATEGORIES_FUNCTION_URL" | awk '{$1=$1};1')"

          echo "➡️ Calling Lambda..."
          HTTP_CODE="$(curl -sS -X POST \
            -H "content-type: application/json" \
            -d "$REQUEST_JSON" \
            -o /tmp/categories_resp.txt \
            -w "%{http_code}" \
            "$CATEGORIES_FUNCTION_URL" || true)"

          echo "HTTP $HTTP_CODE"
          echo "----- response (first 200 lines) -----"
          sed -n '1,200p' /tmp/categories_resp.txt || true
          echo "-------------------------------------"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "❌ Lambda call failed"
            exit 1
          fi

          # Validate and format JSON output
          python3 -m json.tool < /tmp/categories_resp.txt > "$OUT_FILE"

          echo "✅ Wrote $OUT_FILE"
          head -n 40 "$OUT_FILE" || true

      - name: Commit and push if changed
        shell: bash
        run: |
          set -euo pipefail

          FILE="public/wordcache/categories.json"

          if [ ! -f "$FILE" ]; then
            echo "❌ Expected output file missing: $FILE"
            exit 1
          fi

          # Detect changes INCLUDING new (untracked) files
          if [ -z "$(git status --porcelain -- "$FILE")" ]; then
            echo "ℹ️ No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          git commit -m "Update category labels index"
          git push

