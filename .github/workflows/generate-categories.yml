name: Generate Wordcache Category Labels

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

permissions:
  contents: write

jobs:
  generate-categories:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Send folder slugs to Lambda and write categories.json
        shell: bash
        env:
          CATEGORIES_FUNCTION_URL: ${{ secrets.CATEGORIES_FUNCTION_URL }}
        run: |
          set -euo pipefail

          BASE_DIR="public/wordcache"
          OUT_FILE="${BASE_DIR}/categories.json"

          if [ -z "${CATEGORIES_FUNCTION_URL:-}" ]; then
            echo "❌ Missing secret: CATEGORIES_FUNCTION_URL"
            exit 1
          fi

          if [ ! -d "$BASE_DIR" ]; then
            echo "❌ Missing folder: $BASE_DIR"
            exit 1
          fi

          # Collect top-level folders (slugs)
          mapfile -t SLUGS < <(find "$BASE_DIR" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort)

          if [ "${#SLUGS[@]}" -eq 0 ]; then
            echo "❌ No category folders found under $BASE_DIR"
            exit 1
          fi

          echo "✅ Found ${#SLUGS[@]} category folders:"
          printf ' - %s\n' "${SLUGS[@]}"

          # Make SLUGS_TEXT available to python via environment
          export SLUGS_TEXT
          SLUGS_TEXT="$(printf "%s\n" "${SLUGS[@]}")"

          # Build JSON payload via python (proper escaping)
          REQUEST_JSON="$(python3 - <<'PY'
import json, os
slugs_text = os.environ.get("SLUGS_TEXT", "")
slugs = [line.strip() for line in slugs_text.splitlines() if line.strip()]
payload = {
  "slugs": slugs,
  "base_path": "public/wordcache"
}
print(json.dumps(payload))
PY
          )"

          echo "➡️ Calling Lambda..."
          curl -sS -X POST \
            -H "content-type: application/json" \
            -d "$REQUEST_JSON" \
            "$CATEGORIES_FUNCTION_URL" \
            | python3 -m json.tool \
            > "$OUT_FILE"

          echo "✅ Wrote $OUT_FILE"
          head -n 40 "$OUT_FILE" || true

      - name: Commit and push if changed
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "ℹ️ No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add public/wordcache/categories.json
          git commit -m "Update category labels index"
          git push

