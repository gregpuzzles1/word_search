name: Generate Word Search Cache

on:
  workflow_dispatch:
  # Uncomment to run on every push to main
  # push:
  #   branches: [ main ]

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate animals word lists (easy / medium / hard)
        shell: bash
        run: |
          set -euo pipefail

          URL="${{ secrets.WORDS_FUNCTION_URL }}?topic=animals&count=20&all=1"
          echo "Calling: $URL"

          # Save response body and capture HTTP status code
          STATUS=$(curl -sS -o /tmp/animals_all.json -w "%{http_code}" "$URL" || true)

          echo "HTTP status: $STATUS"
          echo "First 300 chars of response:"
          head -c 300 /tmp/animals_all.json || true
          echo ""

          # If not HTTP 200, fail and print full response
          if [ "$STATUS" != "200" ]; then
            echo "❌ Lambda failed. Full response:"
            cat /tmp/animals_all.json || true
            exit 1
          fi

          # Validate JSON before parsing
          node -e '
            const fs = require("fs");
            const txt = fs.readFileSync("/tmp/animals_all.json","utf8").trim();
            try { JSON.parse(txt); }
            catch(e) {
              console.error("❌ Not valid JSON. First 500 chars:\n" + txt.slice(0,500));
              process.exit(1);
            }
            console.log("✅ JSON looks valid");
          '

          # Split into three cache files inside your existing repo directory
          node -e '
            const fs = require("fs");
            const d = JSON.parse(fs.readFileSync("/tmp/animals_all.json","utf8"));

            fs.writeFileSync(
              "public/wordcache/general_knowledge/animals_easy.json",
              JSON.stringify({ topic: d.topic, difficulty: "easy", count: d.count, words: d.easy }, null, 2)
            );
            fs.writeFileSync(
              "public/wordcache/general_knowledge/animals_medium.json",
              JSON.stringify({ topic: d.topic, difficulty: "medium", count: d.count, words: d.medium }, null, 2)
            );
            fs.writeFileSync(
              "public/wordcache/general_knowledge/animals_hard.json",
              JSON.stringify({ topic: d.topic, difficulty: "hard", count: d.count, words: d.hard }, null, 2)
            );
          '

      - name: Commit generated files
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add public/wordcache/general_knowledge/*.json
          git commit -m "Update animals word cache" || echo "No changes to commit"
          git push

